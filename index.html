<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quản lý chi tiêu</title>
  <style>
    :root{
      --bg:#0f172a;
      --panel:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --border:#1f2937;
      --input:#0b1220;
      --chip:#1f2937;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#0b1020,#0f172a 40%,#0b1020);
      color:var(--text);
    }
    header{
      padding:20px 16px; border-bottom:1px solid var(--border);
      position:sticky; top:0; backdrop-filter:saturate(160%) blur(8px);
      background:rgba(15,23,42,.7); z-index:10;
    }
    .container{max-width:1100px; margin:0 auto; padding:20px 16px 80px}
    h1{margin:0; font-size:20px; letter-spacing:.2px}
    .grid{
      display:grid; gap:16px;
      grid-template-columns:1.2fr .8fr;
    }
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
      border:1px solid var(--border); border-radius:14px; overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{font-size:16px; margin:0 0 12px 0}
    .card .body{padding:16px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row > .col{flex:1; min-width:160px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select, button, textarea{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid var(--border); background:var(--input); color:var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.15)}
    button{
      background:#2563eb; border:1px solid #1d4ed8; cursor:pointer; font-weight:600;
    }
    button.secondary{background:#334155; border-color:#334155}
    button.ghost{background:transparent; border-color:var(--border)}
    button.danger{background:var(--danger); border-color:#dc2626}
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .stats{
      display:grid; grid-template-columns:repeat(3,1fr); gap:12px;
    }
    @media (max-width:600px){ .stats{grid-template-columns:1fr} }
    .stat{
      background:var(--panel); border:1px solid var(--border); border-radius:12px;
      padding:14px;
    }
    .stat .label{font-size:12px; color:var(--muted)}
    .stat .value{font-size:20px; font-weight:700}
    .value.plus{color:var(--accent)}
    .value.minus{color:#f87171}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      background:var(--chip); border:1px solid var(--border); padding:6px 10px;
      border-radius:999px; font-size:12px; color:var(--muted)
    }
    table{width:100%; border-collapse:collapse; font-size:14px}
    thead th{
      text-align:left; color:var(--muted); font-weight:600; padding:10px 8px;
      position:sticky; top:60px; background:rgba(15,23,42,.85); backdrop-filter:blur(6px);
      border-bottom:1px solid var(--border); z-index:5;
    }
    tbody td{padding:12px 8px; border-bottom:1px solid var(--border)}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .tag{
      padding:2px 8px; border-radius:999px; font-size:12px;
      background:#0b3b23; color:#34d399; border:1px solid #14532d
    }
    .tag.expense{background:#3b0b0b; color:#fca5a5; border-color:#7f1d1d}
    .right{text-align:right}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .grow{flex:1}
    .muted{color:var(--muted); font-size:12px}
    .empty{padding:24px; text-align:center; color:var(--muted)}
    .footer{
      position:fixed; bottom:12px; right:12px; display:flex; gap:10px;
    }
    .hidden{display:none !important}
  </style>
</head>
<body>
  <header>
    <h1>Quản lý chi tiêu</h1>
    <div class="muted">Lưu cục bộ bằng LocalStorage • Không cần kết nối mạng</div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Form nhập -->
      <div class="card">
        <div class="body">
          <h2>Thêm giao dịch</h2>
          <form id="txForm">
            <div class="row">
              <div class="col">
                <label for="date">Ngày</label>
                <input type="date" id="date" required />
              </div>
              <div class="col">
                <label for="type">Loại</label>
                <select id="type">
                  <option value="income">Thu</option>
                  <option value="expense">Chi</option>
                </select>
              </div>
              <div class="col">
                <label for="category">Danh mục</label>
                <input id="category" placeholder="Ăn uống, Lương, Đi lại..." />
              </div>
              <div class="col">
                <label for="amount">Số tiền</label>
                <input id="amount" type="number" step="0.01" min="0" placeholder="0" required />
              </div>
              <div class="col" style="flex-basis:100%">
                <label for="note">Mô tả</label>
                <input id="note" placeholder="Ghi chú ngắn..." />
              </div>
            </div>
            <div class="actions" style="margin-top:12px">
              <button type="submit">Lưu giao dịch</button>
              <button type="button" id="resetForm" class="ghost">Xóa form</button>
            </div>
            <div class="chips" style="margin-top:12px">
              <div class="chip">Mẹo: Nhập nhanh với Tab ↹</div>
              <div class="chip">Dấu âm không cần, chọn loại Chi</div>
              <div class="chip">Ctrl/Cmd+K để tìm kiếm</div>
            </div>
          </form>
        </div>
      </div>

      <!-- Thống kê & bộ lọc -->
      <div class="card">
        <div class="body">
          <h2>Tổng quan</h2>
          <div class="stats" id="stats">
            <div class="stat">
              <div class="label">Tổng thu</div>
              <div class="value plus" id="sumIncome">0</div>
            </div>
            <div class="stat">
              <div class="label">Tổng chi</div>
              <div class="value minus" id="sumExpense">0</div>
            </div>
            <div class="stat">
              <div class="label">Số dư</div>
              <div class="value" id="balance">0</div>
            </div>
          </div>

          <h2 style="margin-top:16px">Bộ lọc</h2>
          <div class="row">
            <div class="col">
              <label for="filterType">Theo loại</label>
              <select id="filterType">
                <option value="all">Tất cả</option>
                <option value="income">Thu</option>
                <option value="expense">Chi</option>
              </select>
            </div>
            <div class="col">
              <label for="filterMonth">Theo tháng</label>
              <input type="month" id="filterMonth" />
            </div>
            <div class="col">
              <label for="search">Tìm kiếm</label>
              <input id="search" placeholder="Mô tả, danh mục..." />
            </div>
          </div>
          <div class="actions" style="margin-top:12px">
            <button id="applyFilter" class="secondary">Áp dụng</button>
            <button id="clearFilter" class="ghost">Xóa lọc</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bảng giao dịch -->
    <div class="card" style="margin-top:16px">
      <div class="body">
        <div class="toolbar">
          <h2 style="margin-right:auto">Danh sách giao dịch</h2>
          <div class="muted" id="countInfo">0 giao dịch</div>
        </div>
        <div class="table-wrap" style="overflow:auto; max-height:55vh; margin-top:8px">
          <table>
            <thead>
              <tr>
                <th style="width:120px">Ngày</th>
                <th>Mô tả</th>
                <th>Danh mục</th>
                <th style="width:110px">Loại</th>
                <th class="right" style="width:140px">Số tiền</th>
                <th style="width:110px">Thao tác</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr class="emptyRow"><td colspan="6" class="empty">Chưa có dữ liệu</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Xuất/Nhập -->
    <div class="card" style="margin-top:16px">
      <div class="body">
        <h2>Sao lưu & nhập dữ liệu</h2>
        <div class="row">
          <div class="col">
            <label>Dữ liệu JSON</label>
            <textarea id="ioArea" rows="6" placeholder="Dữ liệu sẽ hiện ở đây khi xuất, hoặc dán JSON để nhập"></textarea>
          </div>
        </div>
        <div class="actions" style="margin-top:12px">
          <button id="exportBtn" class="secondary">Xuất JSON</button>
          <button id="importBtn" class="ghost">Nhập JSON</button>
          <button id="clearAllBtn" class="danger">Xóa tất cả</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Nút nhanh -->
  <div class="footer">
    <button id="quickThisMonth" class="secondary">Lọc tháng này</button>
    <button id="addDemo" class="ghost">Thêm dữ liệu mẫu</button>
  </div>

  <script>
    // --------- Trợ giúp ----------
    const $ = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
    const fmt = new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND',maximumFractionDigits:0});
    const today = ()=>new Date().toISOString().slice(0,10);
    const ym = d => d.slice(0,7); // yyyy-MM
    const uid = ()=>crypto.randomUUID?.():(Date.now().toString(36)+Math.random().toString(36).slice(2,8));

    // --------- Trạng thái ----------
    let state = {
      items: [], // {id,date,type,category,amount,note}
      filter: { type:'all', month:'', q:'' }
    };
    const LS_KEY = 'expense_manager_v1';

    // --------- Lưu/đọc ----------
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        try{ state = JSON.parse(raw); }
        catch(e){ console.warn('Dữ liệu lỗi, reset.'); state = {items:[],filter:{type:'all',month:'',q:''}}; }
      }
    }

    // --------- Tính toán ----------
    function filtered(){
      const {type,month,q} = state.filter;
      return state.items.filter(x=>{
        if(type!=='all' && x.type!==type) return false;
        if(month && ym(x.date)!==month) return false;
        if(q){
          const s = (x.note+' '+x.category).toLowerCase();
          if(!s.includes(q.toLowerCase())) return false;
        }
        return true;
      });
    }
    function totals(list){
      let inc=0, exp=0;
      for(const x of list){
        if(x.type==='income') inc += x.amount;
        else exp += x.amount;
      }
      return {inc, exp, bal: inc-exp};
    }

    // --------- Render ----------
    function render(){
      // stats
      const list = filtered();
      const t = totals(list);
      $('#sumIncome').textContent = fmt.format(t.inc);
      $('#sumExpense').textContent = fmt.format(t.exp);
      const balEl = $('#balance');
      balEl.textContent = fmt.format(t.bal);
      balEl.classList.toggle('plus', t.bal>=0);
      balEl.classList.toggle('minus', t.bal<0);
      $('#countInfo').textContent = `${list.length} giao dịch`;

      // table
      const tb = $('#tableBody');
      tb.innerHTML = '';
      if(list.length===0){
        const tr=document.createElement('tr');
        tr.innerHTML = `<td colspan="6" class="empty">Không có giao dịch phù hợp</td>`;
        tb.appendChild(tr);
      }else{
        for(const x of list.sort((a,b)=>b.date.localeCompare(a.date))){
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td>${x.date}</td>
            <td>${escapeHtml(x.note||'')}</td>
            <td>${escapeHtml(x.category||'')}</td>
            <td><span class="tag ${x.type==='expense'?'expense':''}">${x.type==='income'?'Thu':'Chi'}</span></td>
            <td class="right">${fmt.format(x.amount)}</td>
            <td>
              <button class="ghost" data-edit="${x.id}">Sửa</button>
              <button class="danger" data-del="${x.id}">Xóa</button>
            </td>
          `;
          tb.appendChild(tr);
        }
      }
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#039;' }[c]));
    }

    // --------- Sự kiện ----------
    function bindEvents(){
      // form
      $('#txForm').addEventListener('submit', e=>{
        e.preventDefault();
        const item = {
          id: uid(),
          date: $('#date').value || today(),
          type: $('#type').value,
          category: $('#category').value.trim(),
          amount: Number($('#amount').value)||0,
          note: $('#note').value.trim()
        };
        if(!item.amount || item.amount<0){ alert('Số tiền không hợp lệ.'); return; }
        state.items.push(item);
        save(); render();
        $('#txForm').reset();
        $('#date').value = today();
        $('#type').value = 'expense';
      });
      $('#resetForm').addEventListener('click', ()=>{ $('#txForm').reset(); $('#date').value=today(); });

      // filter
      $('#applyFilter').addEventListener('click', ()=>{
        state.filter.type = $('#filterType').value;
        state.filter.month = $('#filterMonth').value;
        state.filter.q = $('#search').value.trim();
        save(); render();
      });
      $('#clearFilter').addEventListener('click', ()=>{
        state.filter = {type:'all',month:'',q:''};
        $('#filterType').value='all'; $('#filterMonth').value=''; $('#search').value='';
        save(); render();
      });

      // search shortcut
      document.addEventListener('keydown', (e)=>{
        if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $('#search').focus(); }
      });

      // table actions
      $('#tableBody').addEventListener('click', e=>{
        const del = e.target.closest('[data-del]');
        const edit = e.target.closest('[data-edit]');
        if(del){
          const id = del.getAttribute('data-del');
          const i = state.items.findIndex(x=>x.id===id);
          if(i>-1 && confirm('Xóa giao dịch này?')){ state.items.splice(i,1); save(); render(); }
        }
        if(edit){
          const id = edit.getAttribute('data-edit');
          const item = state.items.find(x=>x.id===id);
          if(!item) return;
          const nd = prompt('Ngày (YYYY-MM-DD):', item.date) || item.date;
          const nt = prompt('Loại (income/expense):', item.type) || item.type;
          const nc = prompt('Danh mục:', item.category) || item.category;
          const na = Number(prompt('Số tiền:', item.amount) || item.amount);
          const nn = prompt('Mô tả:', item.note) || item.note;
          if(!na || na<0){ alert('Số tiền không hợp lệ.'); return; }
          Object.assign(item, {date:nd, type:nt==='income'?'income':'expense', category:nc, amount:na, note:nn});
          save(); render();
        }
      });

      // export/import/clear
      $('#exportBtn').addEventListener('click', ()=>{
        const data = JSON.stringify(state.items, null, 2);
        $('#ioArea').value = data;
        // download file
        const blob = new Blob([data], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `giao_dich_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      });

      $('#importBtn').addEventListener('click', ()=>{
        let raw = $('#ioArea').value.trim();
        if(!raw){ alert('Dán JSON vào ô văn bản trước.'); return; }
        try{
          const arr = JSON.parse(raw);
          if(!Array.isArray(arr)) throw new Error('Sai định dạng');
          // chuẩn hóa
          const cleaned = arr.map(x=>({
            id: x.id || uid(),
            date: (x.date||today()).slice(0,10),
            type: x.type==='income'?'income':'expense',
            category: String(x.category||''),
            amount: Number(x.amount)||0,
            note: String(x.note||'')
          })).filter(x=>x.amount>0);
          state.items = cleaned;
          save(); render();
          alert('Nhập dữ liệu thành công!');
        }catch(e){
          alert('JSON không hợp lệ: '+e.message);
        }
      });

      $('#clearAllBtn').addEventListener('click', ()=>{
        if(confirm('Xóa toàn bộ dữ liệu? Điều này không thể hoàn tác.')){
          state.items = []; save(); render();
        }
      });

      // quick actions
      $('#quickThisMonth').addEventListener('click', ()=>{
        const m = new Date(); const month = `${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,'0')}`;
        state.filter = { type:'all', month, q:'' };
        $('#filterType').value='all'; $('#filterMonth').value=month; $('#search').value='';
        save(); render();
      });

      $('#addDemo').addEventListener('click', ()=>{
        const base = ym(today());
        const demo = [
          {date:`${base}-01`, type:'income',  category:'Lương', amount:15_000_000, note:'Tháng này'},
          {date:`${base}-02`, type:'expense', category:'Ăn uống', amount:120_000, note:'Bún chả'},
          {date:`${base}-03`, type:'expense', category:'Đi lại', amount:60_000, note:'Xăng'},
          {date:`${base}-05`, type:'expense', category:'Giải trí', amount:200_000, note:'Phim'},
          {date:`${base}-10`, type:'expense', category:'Mua sắm', amount:350_000, note:'Áo thun'},
          {date:`${base}-12`, type:'income',  category:'Freelance', amount:3_000_000, note:'Thiết kế'},
        ].map(x=>({...x, id:uid()}));
        state.items.push(...demo);
        save(); render();
      });
    }

    // --------- Khởi động ----------
    function init(){
      load();
      // default form values
      $('#date').value = today();
      $('#type').value = 'expense';
      // filter UI sync
      $('#filterType').value = state.filter?.type || 'all';
      $('#filterMonth').value = state.filter?.month || '';
      $('#search').value = state.filter?.q || '';
      bindEvents();
      render();
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
