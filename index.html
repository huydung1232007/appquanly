<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Chi ti√™u</title>
    <!-- Th∆∞ vi·ªán Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 600px;
        }
        .calendar-grid {
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        .calendar-day-cell {
            padding: 0.75rem;
            font-size: 0.875rem;
            position: relative;
        }
        .note-marker {
            position: absolute;
            top: 4px;
            right: 4px;
            color: #ffc107;
            font-size: 0.75rem;
        }
        @media (min-width: 640px) {
            .calendar-day-cell {
                padding: 1rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 bg-gray-100 sm:p-4">

    <div class="container bg-white p-4 rounded-2xl shadow-xl border border-gray-200 w-full sm:p-6">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-gray-800 sm:text-3xl">Qu·∫£n l√Ω Thu - Chi</h1>
            <button id="open-settings-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8V6m0 6a2 2 0 100 4m0-4a2 2 0 110 4m12 0v-2m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6-8V2m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6-8v-2m0 2a2 2 0 100 4m0-4a2 2 0 110 4" />
                </svg>
            </button>
        </div>

        <!-- Calendar Header -->
        <div class="flex items-center justify-between mb-6">
            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <div class="text-lg font-semibold text-gray-700 sm:text-xl" id="current-month-year"></div>
            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>

        <!-- Calendar Grid -->
        <div class="grid calendar-grid text-center font-medium text-gray-500 mb-6">
            <span class="py-2">T2</span>
            <span class="py-2">T3</span>
            <span class="py-2">T4</span>
            <span class="py-2">T5</span>
            <span class="py-2">T6</span>
            <span class="py-2">T7</span>
            <span class="py-2">CN</span>
        </div>
        <div class="grid calendar-grid text-center mb-6" id="calendar-days">
            <!-- C√°c ng√†y c·ªßa l·ªãch s·∫Ω ƒë∆∞·ª£c t·∫°o ·ªü ƒë√¢y -->
        </div>

        <!-- Summary Section -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 text-center">
            <div class="bg-blue-100 p-4 rounded-xl shadow-inner">
                <h2 class="text-md font-medium text-blue-800">T·ªïng Thu nh·∫≠p:</h2>
                <span id="total-income" class="text-xl font-bold text-blue-600">0 VND</span>
            </div>
            <div class="bg-red-100 p-4 rounded-xl shadow-inner">
                <h2 class="text-md font-medium text-red-800">T·ªïng Chi ti√™u:</h2>
                <span id="total-expense" class="text-xl font-bold text-red-600">0 VND</span>
            </div>
            <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
                <h2 class="text-md font-medium text-gray-800">S·ªë d∆∞:</h2>
                <span id="balance-amount" class="text-xl font-bold text-gray-800">0 VND</span>
            </div>
        </div>

        <!-- Add Transaction Button -->
        <div class="text-center mb-6">
            <button id="open-transaction-panel-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg shadow-lg transition-colors duration-200">
                Th√™m Giao d·ªãch
            </button>
        </div>

        <!-- Category Summary Section -->
        <h2 class="text-xl font-bold text-gray-800 mb-4">T·ªïng chi ti√™u theo danh m·ª•c</h2>
        <ul id="category-summary-list" class="space-y-2 mb-6">
            <!-- T√≥m t·∫Øt theo danh m·ª•c s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
        </ul>

        <!-- Transaction List Section -->
        <h2 class="text-xl font-bold text-gray-800 mb-4">L·ªãch s·ª≠ Giao d·ªãch</h2>
        <ul id="transaction-list" class="space-y-3">
            <!-- C√°c m·ª•c giao d·ªãch s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
        </ul>
    </div>

    <!-- Transaction Panel (Pop-up) -->
    <div id="transaction-panel" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 hidden">
        <div class="relative bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm">
            <button id="close-transaction-panel-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Th√™m Giao d·ªãch</h2>

            <!-- Input Section inside Panel -->
            <div class="flex flex-col gap-4 mb-4">
                <input type="text" id="description" placeholder="M√¥ t·∫£" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="number" id="amount" placeholder="S·ªë ti·ªÅn (VND)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                    <select id="category" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                        <option value="">Ch·ªçn danh m·ª•c</option>
                        <option value="ƒÇn u·ªëng">ƒÇn u·ªëng</option>
                        <option value="ƒêi l·∫°i">ƒêi l·∫°i</option>
                        <option value="Mua s·∫Øm">Mua s·∫Øm</option>
                        <option value="H√≥a ƒë∆°n">H√≥a ƒë∆°n</option>
                        <option value="S·ª©c kh·ªèe">S·ª©c kh·ªèe</option>
                        <option value="Gi·∫£i tr√≠">Gi·∫£i tr√≠</option>
                        <option value="Kh√°c">Kh√°c</option>
                    </select>
                </div>
                <input type="date" id="transaction-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
            </div>
            <div class="flex flex-col gap-4 mb-2 sm:flex-row">
                <button id="add-expense-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-200">
                    Th√™m Chi ti√™u
                </button>
                <button id="add-income-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-200">
                    Th√™m Thu nh·∫≠p
                </button>
            </div>
        </div>
    </div>

    <!-- Note Panel (Pop-up) -->
    <div id="note-panel" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 hidden">
        <div class="relative bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm">
            <button id="close-note-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6" id="note-panel-title">Ghi ch√∫ cho ng√†y 17</h2>

            <textarea id="note-content" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200" rows="5" placeholder="Vi·∫øt ghi ch√∫ c·ªßa b·∫°n ·ªü ƒë√¢y..."></textarea>

            <div class="mt-4 flex flex-col gap-4">
                 <button id="save-note-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-200">
                    L∆∞u Ghi ch√∫
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Panel (Pop-up) -->
    <div id="settings-panel" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 hidden">
        <div class="relative bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm">
            <button id="close-settings-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">C√†i ƒë·∫∑t</h2>
            
            <!-- Gemini Feature -->
            <button id="analyze-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-200 mb-4">
                ‚ú® Ph√¢n t√≠ch chi ti√™u
            </button>
            
            <!-- Chatbot Button -->
            <button id="open-chatbot-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-200 mb-4">
                ü§ñ Chatbot Gemini
            </button>


            <div class="flex flex-col gap-4">
                <button id="export-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-200">
                    Xu·∫•t d·ªØ li·ªáu
                </button>
                <input type="file" id="import-file-input" class="hidden">
                <button id="import-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-200">
                    Nh·∫≠p d·ªØ li·ªáu
                </button>
            </div>
        </div>
    </div>
    
    <!-- Analysis Panel (Pop-up) -->
    <div id="analysis-panel" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 hidden">
        <div class="relative bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm sm:max-w-md md:max-w-lg lg:max-w-xl">
            <button id="close-analysis-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Ph√¢n t√≠ch Chi ti√™u</h2>
            <div id="analysis-content" class="prose max-w-none">
                <!-- Analysis results will be loaded here -->
            </div>
            <div id="analysis-loading" class="flex items-center justify-center hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
            </div>
        </div>
    </div>
    
    <!-- Chatbot Panel (Pop-up) -->
    <div id="chatbot-panel" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 hidden">
        <div class="relative bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm">
            <button id="close-chatbot-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Chatbot Gemini</h2>
            <div id="chat-container" class="h-96 overflow-y-auto mb-4 p-2 border border-gray-300 rounded-lg">
                <div class="text-center text-gray-400 italic">H√£y b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán...</div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="send-chat-btn" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
            const amountInput = document.getElementById('amount');
            const descriptionInput = document.getElementById('description');
            const categorySelect = document.getElementById('category');
            const transactionDateInput = document.getElementById('transaction-date');
            const transactionList = document.getElementById('transaction-list');
            const totalIncomeSpan = document.getElementById('total-income');
            const totalExpenseSpan = document.getElementById('total-expense');
            const balanceAmountSpan = document.getElementById('balance-amount');
            const categorySummaryList = document.getElementById('category-summary-list');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const currentMonthYearDiv = document.getElementById('current-month-year');
            const calendarDaysDiv = document.getElementById('calendar-days');

            // Panels
            const openTransactionPanelBtn = document.getElementById('open-transaction-panel-btn');
            const closeTransactionPanelBtn = document.getElementById('close-transaction-panel-btn');
            const transactionPanel = document.getElementById('transaction-panel');
            const addExpenseBtn = document.getElementById('add-expense-btn');
            const addIncomeBtn = document.getElementById('add-income-btn');
            
            const notePanel = document.getElementById('note-panel');
            const closeNoteBtn = document.getElementById('close-note-btn');
            const notePanelTitle = document.getElementById('note-panel-title');
            const noteContentTextarea = document.getElementById('note-content');
            const saveNoteBtn = document.getElementById('save-note-btn');

            // Settings Panel
            const openSettingsBtn = document.getElementById('open-settings-btn');
            const closeSettingsBtn = document.getElementById('close-settings-btn');
            const settingsPanel = document.getElementById('settings-panel');

            // Import/Export
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFileInput = document.getElementById('import-file-input');
            
            // Analysis Panel
            const analyzeBtn = document.getElementById('analyze-btn');
            const analysisPanel = document.getElementById('analysis-panel');
            const analysisContent = document.getElementById('analysis-content');
            const analysisLoading = document.getElementById('analysis-loading');
            const closeAnalysisBtn = document.getElementById('close-analysis-btn');
            
            // Chatbot Panel
            const openChatbotBtn = document.getElementById('open-chatbot-btn');
            const closeChatbotBtn = document.getElementById('close-chatbot-btn');
            const chatbotPanel = document.getElementById('chatbot-panel');
            const chatContainer = document.getElementById('chat-container');
            const chatInput = document.getElementById('chat-input');
            const sendChatBtn = document.getElementById('send-chat-btn');


            // Kh·ªüi t·∫°o d·ªØ li·ªáu
            let transactions = [];
            let notes = {};
            let currentDisplayDate = new Date();
            let selectedDate = new Date();
            const allCategories = ["ƒÇn u·ªëng", "ƒêi l·∫°i", "Mua s·∫Øm", "H√≥a ƒë∆°n", "S·ª©c kh·ªèe", "Gi·∫£i tr√≠", "Kh√°c"];
            
            // H√†m g·ªçi API Gemini v·ªõi exponential backoff
            async function callGeminiApiWithBackoff(prompt, maxRetries = 5, delay = 1000) {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429) { // Too Many Requests
                            console.warn(`API rate limit exceeded. Retrying in ${delay}ms...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2; // Exponential backoff
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`API returned status ${response.status}`);
                        }

                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            throw new Error('Unexpected API response structure or no content.');
                        }
                    } catch (error) {
                        console.error(`Error calling Gemini API: ${error}`);
                        if (i < maxRetries - 1) {
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                        } else {
                            throw error;
                        }
                    }
                }
                throw new Error('Max retries exceeded for Gemini API call.');
            }

            // Hi·ªÉn th·ªã panel giao d·ªãch
            const showTransactionPanel = () => {
                transactionPanel.classList.remove('hidden');
                setTimeout(() => {
                    transactionPanel.classList.remove('opacity-0');
                }, 10);
                setDateInput(selectedDate);
            };

            // ·∫®n panel giao d·ªãch
            const hideTransactionPanel = () => {
                transactionPanel.classList.add('opacity-0');
                setTimeout(() => {
                    transactionPanel.classList.add('hidden');
                }, 300);
            };

            // Hi·ªÉn th·ªã panel ghi ch√∫
            const showNotePanel = () => {
                notePanel.classList.remove('hidden');
                setTimeout(() => {
                    notePanel.classList.remove('opacity-0');
                }, 10);
            };

            // ·∫®n panel ghi ch√∫
            const hideNotePanel = () => {
                notePanel.classList.add('opacity-0');
                setTimeout(() => {
                    notePanel.classList.add('hidden');
                }, 300);
            };

            // Hi·ªÉn th·ªã panel c√†i ƒë·∫∑t
            const showSettingsPanel = () => {
                settingsPanel.classList.remove('hidden');
                setTimeout(() => {
                    settingsPanel.classList.remove('opacity-0');
                }, 10);
            };

            // ·∫®n panel c√†i ƒë·∫∑t
            const hideSettingsPanel = () => {
                settingsPanel.classList.add('opacity-0');
                setTimeout(() => {
                    settingsPanel.classList.add('hidden');
                }, 300);
            };
            
            // Hi·ªÉn th·ªã panel ph√¢n t√≠ch
            const showAnalysisPanel = () => {
                 analysisPanel.classList.remove('hidden');
                 setTimeout(() => {
                     analysisPanel.classList.remove('opacity-0');
                 }, 10);
            };

            // ·∫®n panel ph√¢n t√≠ch
            const hideAnalysisPanel = () => {
                 analysisPanel.classList.add('opacity-0');
                 setTimeout(() => {
                     analysisPanel.classList.add('hidden');
                 }, 300);
            };
            
            // Hi·ªÉn th·ªã panel chatbot
            const showChatbotPanel = () => {
                chatbotPanel.classList.remove('hidden');
                setTimeout(() => {
                    chatbotPanel.classList.remove('opacity-0');
                }, 10);
                chatInput.focus();
            };

            // ·∫®n panel chatbot
            const hideChatbotPanel = () => {
                chatbotPanel.classList.add('opacity-0');
                setTimeout(() => {
                    chatbotPanel.classList.add('hidden');
                }, 300);
            };

            // ƒê·∫∑t ng√†y v√†o √¥ input ng√†y
            const setDateInput = (date) => {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                transactionDateInput.value = `${year}-${month}-${day}`;
            };

            // L∆∞u giao d·ªãch v√† ghi ch√∫ v√†o localStorage
            const saveAllData = () => {
                localStorage.setItem('transactions', JSON.stringify(transactions));
                localStorage.setItem('notes', JSON.stringify(notes));
            };

            // T·∫£i d·ªØ li·ªáu t·ª´ localStorage
            const loadAllData = () => {
                const storedTransactions = localStorage.getItem('transactions');
                if (storedTransactions) {
                    transactions = JSON.parse(storedTransactions);
                }
                const storedNotes = localStorage.getItem('notes');
                if (storedNotes) {
                    notes = JSON.parse(storedNotes);
                }
            };

            // C·∫≠p nh·∫≠t t√≥m t·∫Øt to√†n c·∫ßu (t·ªïng thu nh·∫≠p, chi ti√™u, s·ªë d∆∞)
            const updateGlobalSummary = () => {
                const year = currentDisplayDate.getFullYear();
                const month = currentDisplayDate.getMonth();

                const monthlyTransactions = transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate.getFullYear() === year && transactionDate.getMonth() === month;
                });

                const totalIncome = monthlyTransactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);

                const totalExpense = monthlyTransactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);

                const balance = totalIncome - totalExpense;

                totalIncomeSpan.textContent = `${totalIncome.toLocaleString('vi-VN')} VND`;
                totalExpenseSpan.textContent = `${totalExpense.toLocaleString('vi-VN')} VND`;
                balanceAmountSpan.textContent = `${balance.toLocaleString('vi-VN')} VND`;
            };

            // C·∫≠p nh·∫≠t t√≥m t·∫Øt theo danh m·ª•c cho ng√†y ƒë√£ ch·ªçn
            const updateCategorySummary = () => {
                const selectedDateString = selectedDate.toISOString().split('T')[0];
                const dailyTransactions = transactions.filter(t => t.date === selectedDateString);

                const categoryTotals = {};
                // Kh·ªüi t·∫°o t·∫•t c·∫£ danh m·ª•c v·ªõi gi√° tr·ªã 0
                allCategories.forEach(category => {
                    categoryTotals[category] = 0;
                });

                dailyTransactions.filter(t => t.type === 'expense').forEach(transaction => {
                    if (categoryTotals[transaction.category] !== undefined) {
                        categoryTotals[transaction.category] += transaction.amount;
                    }
                });

                categorySummaryList.innerHTML = '';
                for (const category in categoryTotals) {
                    const total = categoryTotals[category];
                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center bg-gray-100 p-3 rounded-lg';
                    listItem.innerHTML = `
                        <span class="font-medium text-gray-700">${category}:</span>
                        <span class="font-bold text-red-500">${total.toLocaleString('vi-VN')} VND</span>
                    `;
                    categorySummaryList.appendChild(listItem);
                }
            };

            // Hi·ªÉn th·ªã danh s√°ch giao d·ªãch cho ng√†y ƒë√£ ch·ªçn
            const renderTransactions = () => {
                transactionList.innerHTML = '';
                const selectedDateString = selectedDate.toISOString().split('T')[0];
                const dailyTransactions = transactions
                    .filter(t => t.date === selectedDateString)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                dailyTransactions.forEach((transaction) => {
                    const newTransactionItem = document.createElement('li');
                    const colorClass = transaction.type === 'income' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                    const icon = transaction.type === 'income' ?
                        `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>` :
                        `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                        </svg>`;

                    newTransactionItem.className = `flex justify-between items-center p-4 rounded-lg shadow-sm border ${colorClass} transform transition-all duration-200`;

                    const transactionInfo = transaction.type === 'expense' ? `
                        <div class="flex items-center gap-2">
                            ${icon}
                            <div class="flex flex-col">
                                <span class="text-gray-900 font-medium">${transaction.description}</span>
                                <span class="text-gray-500 text-sm italic">${transaction.category} - ${new Date(transaction.timestamp).toLocaleString('vi-VN')}</span>
                            </div>
                        </div>
                        <span class="font-bold text-red-600">${transaction.amount.toLocaleString('vi-VN')} VND</span>
                    ` : `
                        <div class="flex items-center gap-2">
                            ${icon}
                            <div class="flex flex-col">
                                <span class="text-gray-900 font-medium">${transaction.description}</span>
                                <span class="text-gray-500 text-sm italic">Thu nh·∫≠p - ${new Date(transaction.timestamp).toLocaleString('vi-VN')}</span>
                            </div>
                        </div>
                        <span class="font-bold text-green-600">${transaction.amount.toLocaleString('vi-VN')} VND</span>
                    `;

                    newTransactionItem.innerHTML = `
                        ${transactionInfo}
                        <button data-id="${transaction.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors duration-200 ml-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    transactionList.appendChild(newTransactionItem);
                });

                // G√°n s·ª± ki·ªán cho c√°c n√∫t x√≥a
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const transactionId = e.currentTarget.dataset.id;
                        transactions = transactions.filter(t => t.id !== transactionId);
                        saveAllData();
                        renderCalendar(currentDisplayDate);
                        updateCategorySummary();
                        updateGlobalSummary();
                        renderTransactions();
                    });
                });
            };

            // Logic t·∫°o l·ªãch
            const renderCalendar = (date) => {
                calendarDaysDiv.innerHTML = '';
                const monthNames = ["th√°ng 1", "th√°ng 2", "th√°ng 3", "th√°ng 4", "th√°ng 5", "th√°ng 6", "th√°ng 7", "th√°ng 8", "th√°ng 9", "th√°ng 10", "th√°ng 11", "th√°ng 12"];
                const year = date.getFullYear();
                const month = date.getMonth();
                currentMonthYearDiv.textContent = `${monthNames[month]} nƒÉm ${year}`;

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                const selectedDay = selectedDate.getDate();
                const selectedMonth = selectedDate.getMonth();
                const selectedYear = selectedDate.getFullYear();

                const startDay = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
                for (let i = 0; i < startDay; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.classList.add('p-3');
                    calendarDaysDiv.appendChild(emptyCell);
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayCell = document.createElement('div');
                    dayCell.classList.add('p-3', 'rounded-lg', 'cursor-pointer', 'hover:bg-gray-200', 'transition-colors', 'duration-200', 'calendar-day-cell');
                    dayCell.textContent = i;

                    const cellDate = new Date(year, month, i);

                    if (cellDate.getFullYear() === today.getFullYear() && cellDate.getMonth() === today.getMonth() && i === today.getDate()) {
                        dayCell.classList.add('font-bold', 'text-gray-900', 'bg-blue-300');
                    }

                    if (cellDate.getFullYear() === selectedYear && cellDate.getMonth() === selectedMonth && i === selectedDay) {
                        dayCell.classList.add('bg-pink-500', 'text-white', 'hover:bg-pink-600', 'font-bold');
                    }

                    const dayString = new Date(year, month, i).toISOString().split('T')[0];
                    const hasTransaction = transactions.some(t => t.date === dayString);
                    const hasNote = notes[dayString];

                    if (hasTransaction) {
                         dayCell.classList.add('border-b-2', 'border-yellow-500');
                    }
                    if (hasNote) {
                        const noteMarker = document.createElement('span');
                        noteMarker.className = 'note-marker';
                        noteMarker.innerHTML = '&#9998;'; // Bi·ªÉu t∆∞·ª£ng b√∫t
                        dayCell.appendChild(noteMarker);
                    }

                    dayCell.addEventListener('click', () => {
                        selectedDate = new Date(year, month, i);
                        setDateInput(selectedDate);
                        renderCalendar(currentDisplayDate);
                        updateCategorySummary();
                        renderTransactions();

                        const dateString = selectedDate.toISOString().split('T')[0];
                        notePanelTitle.textContent = `Ghi ch√∫ cho ng√†y ${selectedDate.getDate()}`;
                        noteContentTextarea.value = notes[dateString] || '';
                        showNotePanel();
                    });
                    calendarDaysDiv.appendChild(dayCell);
                }
            };

            // H√†m th√™m giao d·ªãch m·ªõi
            const addTransaction = (type) => {
                const amount = parseFloat(amountInput.value);
                const description = descriptionInput.value.trim();
                const category = categorySelect.value;
                const dateFromInput = transactionDateInput.value;

                if (isNaN(amount) || amount <= 0 || description === '') {
                    showMessage('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá v√† m√¥ t·∫£!', 'error');
                    return;
                }

                if (type === 'expense' && category === '') {
                    showMessage('Vui l√≤ng ch·ªçn m·ªôt danh m·ª•c cho chi ti√™u!', 'error');
                    return;
                }

                const newTransaction = {
                    id: Date.now().toString(),
                    description,
                    amount,
                    type,
                    category: type === 'expense' ? category : null,
                    date: dateFromInput,
                    timestamp: new Date().getTime()
                };

                transactions.push(newTransaction);
                saveAllData();
                renderCalendar(currentDisplayDate);
                updateCategorySummary();
                updateGlobalSummary();
                renderTransactions();

                // X√≥a input v√† ƒë√≥ng panel
                amountInput.value = '';
                descriptionInput.value = '';
                categorySelect.value = '';
                hideTransactionPanel();

                showMessage(`ƒê√£ th√™m ${type === 'income' ? 'thu nh·∫≠p' : 'chi ti√™u'} th√†nh c√¥ng!`, 'success');
            };

            // H√†m l∆∞u ghi ch√∫
            const saveNote = () => {
                const dateString = selectedDate.toISOString().split('T')[0];
                const noteContent = noteContentTextarea.value.trim();

                if (noteContent) {
                    notes[dateString] = noteContent;
                } else {
                    delete notes[dateString];
                }

                saveAllData();
                renderCalendar(currentDisplayDate);
                hideNotePanel();
                showMessage('ƒê√£ l∆∞u ghi ch√∫!', 'success');
            };

            // H√†m xu·∫•t d·ªØ li·ªáu ra file JSON
            const exportData = () => {
                const data = {
                    transactions: transactions,
                    notes: notes
                };
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'quan_ly_chi_tieu_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showMessage('ƒê√£ xu·∫•t d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
                hideSettingsPanel();
            };

            // H√†m nh·∫≠p d·ªØ li·ªáu t·ª´ file JSON
            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.transactions && importedData.notes) {
                            transactions = importedData.transactions;
                            notes = importedData.notes;
                            saveAllData();
                            renderCalendar(currentDisplayDate);
                            updateCategorySummary();
                            updateGlobalSummary();
                            renderTransactions();
                            showMessage('ƒê√£ nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
                        } else {
                            showMessage('File kh√¥ng h·ª£p l·ªá!', 'error');
                        }
                    } catch (error) {
                        showMessage('L·ªói khi ƒë·ªçc file!', 'error');
                    }
                };
                reader.readAsText(file);
                hideSettingsPanel();
            };
            
            // H√†m ph√¢n t√≠ch chi ti√™u b·∫±ng Gemini API
            const analyzeSpending = async () => {
                hideSettingsPanel();
                showAnalysisPanel();
                analysisContent.innerHTML = '';
                analysisLoading.classList.remove('hidden');

                const year = currentDisplayDate.getFullYear();
                const month = currentDisplayDate.getMonth();
                const monthlyTransactions = transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate.getFullYear() === year && transactionDate.getMonth() === month;
                });

                if (monthlyTransactions.length === 0) {
                    analysisContent.innerHTML = '<p class="text-center text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu giao d·ªãch ƒë·ªÉ ph√¢n t√≠ch trong th√°ng n√†y.</p>';
                    analysisLoading.classList.add('hidden');
                    return;
                }

                // Prepare a detailed summary for the LLM
                let summary = `D∆∞·ªõi ƒë√¢y l√† c√°c giao d·ªãch c·ªßa t√¥i trong th√°ng ${month + 1} nƒÉm ${year}:\n\n`;
                const monthlyIncome = monthlyTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const monthlyExpense = monthlyTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const monthlyBalance = monthlyIncome - monthlyExpense;

                summary += `T·ªïng thu nh·∫≠p: ${monthlyIncome.toLocaleString('vi-VN')} VND\n`;
                summary += `T·ªïng chi ti√™u: ${monthlyExpense.toLocaleString('vi-VN')} VND\n`;
                summary += `S·ªë d∆∞ cu·ªëi th√°ng: ${monthlyBalance.toLocaleString('vi-VN')} VND\n\n`;

                summary += "Chi ti·∫øt c√°c kho·∫£n chi:\n";
                const expenseDetails = monthlyTransactions.filter(t => t.type === 'expense').map(t => `${t.category}: ${t.amount.toLocaleString('vi-VN')} VND (${t.description})`).join('\n');
                summary += expenseDetails;
                
                const prompt = `Ph√¢n t√≠ch d·ªØ li·ªáu t√†i ch√≠nh sau v√† ƒë∆∞a ra m·ªôt b√°o c√°o ph√¢n t√≠ch chi ti·∫øt, d·ªÖ hi·ªÉu b·∫±ng ti·∫øng Vi·ªát. C·∫•u tr√∫c b√°o c√°o n√™n bao g·ªìm:
1.  **T·ªïng quan:** ƒê√°nh gi√° chung v·ªÅ t√¨nh h√¨nh chi ti√™u trong th√°ng.
2.  **ƒêi·ªÉm n·ªïi b·∫≠t:** N√™u b·∫≠t nh·ªØng ƒëi·ªÉm ƒë√°ng ch√∫ √Ω, ch·∫≥ng h·∫°n nh∆∞ danh m·ª•c chi ti√™u nhi·ªÅu nh·∫•t, chi ti√™u b·∫•t th∆∞·ªùng, ho·∫∑c c√°c th√≥i quen t·ªët/x·∫•u.
3.  **L·ªùi khuy√™n:** ƒê∆∞a ra l·ªùi khuy√™n c·ª• th·ªÉ ƒë·ªÉ c·∫£i thi·ªán qu·∫£n l√Ω chi ti√™u trong th√°ng t·ªõi.
4.  **D·ªØ li·ªáu:**
${summary}`;
                
                try {
                    const analysisText = await callGeminiApiWithBackoff(prompt);
                    analysisContent.innerHTML = `
                        <div class="prose max-w-none p-4 rounded-lg bg-gray-50">
                            <p>${analysisText.replace(/\n/g, '</p><p>')}</p>
                        </div>
                    `;
                } catch (e) {
                    analysisContent.innerHTML = `<p class="text-red-500">L·ªói: Kh√¥ng th·ªÉ ph√¢n t√≠ch d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.</p>`;
                    console.error(e);
                } finally {
                    analysisLoading.classList.add('hidden');
                }
            };
            
            // H√†m g·ª≠i tin nh·∫Øn ƒë·∫øn chatbot
            const sendMessageToChatbot = async (message) => {
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'flex justify-end mb-2';
                userMessageDiv.innerHTML = `<div class="bg-indigo-200 text-gray-800 p-2 rounded-lg max-w-xs">${message}</div>`;
                chatContainer.appendChild(userMessageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'flex justify-start mb-2';
                loadingDiv.innerHTML = `<div class="bg-gray-200 text-gray-800 p-2 rounded-lg max-w-xs"><div class="animate-pulse">...</div></div>`;
                chatContainer.appendChild(loadingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Chu·∫©n b·ªã prompt cho Gemini
                const prompt = `T√¥i c√≥ m·ªôt ·ª©ng d·ª•ng qu·∫£n l√Ω chi ti√™u. D·ªØ li·ªáu c·ªßa t√¥i nh∆∞ sau: ${JSON.stringify(transactions)}. Vui l√≤ng tr·∫£ l·ªùi c√°c c√¢u h·ªèi v·ªÅ t√†i ch√≠nh, ƒë∆∞a ra l·ªùi khuy√™n ho·∫∑c t∆∞∆°ng t√°c nh∆∞ m·ªôt tr·ª£ l√Ω t√†i ch√≠nh. C√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng l√†: "${message}"`;

                try {
                    const botResponse = await callGeminiApiWithBackoff(prompt);
                    loadingDiv.innerHTML = `<div class="bg-gray-200 text-gray-800 p-2 rounded-lg max-w-xs">${botResponse}</div>`;
                } catch (e) {
                    loadingDiv.innerHTML = `<div class="bg-gray-200 text-red-500 p-2 rounded-lg max-w-xs">R·∫•t ti·∫øc, t√¥i kh√¥ng th·ªÉ x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n l√∫c n√†y.</div>`;
                    console.error(e);
                } finally {
                     chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            };


            // H√†m hi·ªÉn th·ªã th√¥ng b√°o t√πy ch·ªânh
            function showMessage(message, type) {
                const existingMessage = document.getElementById('custom-message');
                if (existingMessage) {
                    existingMessage.remove();
                }

                const messageDiv = document.createElement('div');
                messageDiv.id = 'custom-message';
                messageDiv.textContent = message;
                messageDiv.className = 'fixed bottom-5 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform scale-0';

                if (type === 'success') {
                    messageDiv.classList.add('bg-green-500', 'text-white');
                } else if (type === 'error') {
                    messageDiv.classList.add('bg-red-500', 'text-white');
                }

                document.body.appendChild(messageDiv);

                setTimeout(() => {
                    messageDiv.classList.remove('scale-0');
                    messageDiv.classList.add('scale-100');
                }, 50);

                setTimeout(() => {
                    messageDiv.classList.remove('scale-100');
                    messageDiv.classList.add('scale-0');
                    setTimeout(() => messageDiv.remove(), 300);
                }, 3000);
            }

            // G√°n s·ª± ki·ªán cho c√°c n√∫t
            openTransactionPanelBtn.addEventListener('click', showTransactionPanel);
            closeTransactionPanelBtn.addEventListener('click', hideTransactionPanel);
            closeNoteBtn.addEventListener('click', hideNotePanel);
            saveNoteBtn.addEventListener('click', saveNote);
            
            addExpenseBtn.addEventListener('click', () => addTransaction('expense'));
            addIncomeBtn.addEventListener('click', () => addTransaction('income'));

            exportBtn.addEventListener('click', exportData);
            importBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', importData);
            
            openSettingsBtn.addEventListener('click', showSettingsPanel);
            closeSettingsBtn.addEventListener('click', hideSettingsPanel);
            analyzeBtn.addEventListener('click', analyzeSpending);
            closeAnalysisBtn.addEventListener('click', hideAnalysisPanel);
            
            openChatbotBtn.addEventListener('click', () => {
                hideSettingsPanel();
                showChatbotPanel();
            });
            closeChatbotBtn.addEventListener('click', hideChatbotPanel);
            sendChatBtn.addEventListener('click', () => {
                const message = chatInput.value.trim();
                if (message) {
                    sendMessageToChatbot(message);
                    chatInput.value = '';
                }
            });
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChatBtn.click();
                }
            });


            transactionDateInput.addEventListener('change', () => {
                if (transactionDateInput.value) {
                    selectedDate = new Date(transactionDateInput.value);
                    renderCalendar(selectedDate);
                    updateCategorySummary();
                    renderTransactions();
                }
            });

            prevMonthBtn.addEventListener('click', () => {
                currentDisplayDate.setMonth(currentDisplayDate.getMonth() - 1);
                renderCalendar(currentDisplayDate);
                updateGlobalSummary();
            });

            nextMonthBtn.addEventListener('click', () => {
                currentDisplayDate.setMonth(currentDisplayDate.getMonth() + 1);
                renderCalendar(currentDisplayDate);
                updateGlobalSummary();
            });

            // T·∫£i d·ªØ li·ªáu ban ƒë·∫ßu
            loadAllData();
            renderCalendar(currentDisplayDate);
            updateCategorySummary();
            updateGlobalSummary();
            renderTransactions();
        });
    </script>
</body>
</html>
