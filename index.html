<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Qu·∫£n L√Ω Chi Ti√™u (Backup Google Drive)</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Google Identity Services (for OAuth tokens) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    html, body { height: 100%; }
    .card { box-shadow: 0 10px 25px rgba(0,0,0,.06); }
    .scroll-smooth { scroll-behavior: smooth; }
    .btn { @apply px-3 py-2 rounded-lg font-medium transition; }
    .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700; }
    .btn-danger { @apply bg-red-600 text-white hover:bg-red-700; }
    .btn-ghost { @apply bg-white hover:bg-gray-100; }
    .chip { @apply text-xs bg-gray-100 rounded px-2 py-1; }
    .input { @apply w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500; }
    .select { @apply w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500; }
    .muted { @apply text-gray-500; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 scroll-smooth">
  <div class="max-w-5xl mx-auto p-4 sm:p-6">
    <header class="mb-4 sm:mb-6 flex items-center justify-between gap-3 flex-wrap">
      <h1 class="text-2xl sm:text-3xl font-extrabold">üí∞ Qu·∫£n L√Ω Chi Ti√™u</h1>
      <div class="flex flex-wrap items-center gap-2">
        <button id="btn-export" class="btn btn-ghost">T·∫£i JSON</button>
        <label class="btn btn-ghost cursor-pointer">
          Nh·∫≠p JSON <input id="file-import" type="file" accept="application/json" class="hidden">
        </label>
        <button id="btn-backup-now" class="btn btn-primary">Sao l∆∞u ngay ‚Üí Drive</button>

        <!-- Settings dropdown -->
        <div class="relative">
          <button id="btn-settings" class="btn btn-ghost">‚öôÔ∏è C√†i ƒë·∫∑t</button>
          <div id="panel-settings" class="hidden absolute right-0 mt-2 w-[28rem] max-w-[90vw] bg-white border border-gray-200 rounded-xl p-4 z-10 card">
            <div class="font-semibold mb-2">Google Drive</div>
            <div class="space-y-2 text-sm">
              <div>
                <label class="block text-xs muted mb-1">Google OAuth Client ID</label>
                <input id="gis-client-id" class="input" placeholder="vd: 1234567890-xxxxxxxx.apps.googleusercontent.com">
                <div class="text-xs muted mt-1">T·∫°o trong <b>Google Cloud Console ‚Üí Credentials ‚Üí OAuth 2.0 Client IDs</b>. App type: Web. Authorized JS origins: file:// kh√¥ng c·∫ßn; ch·∫°y file n√†y tr·ª±c ti·∫øp ƒë∆∞·ª£c.</div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-xs muted mb-1">T√™n file backup (tr√™n Drive)</label>
                  <input id="drive-filename" class="input" placeholder="chi_tieu.json" value="chi_tieu.json">
                </div>
                <div>
                  <label class="block text-xs muted mb-1">File ID (n·∫øu ƒë√£ c√≥)</label>
                  <input id="drive-fileid" class="input" placeholder="(t·ª± t·∫°o n·∫øu ƒë·ªÉ tr·ªëng)">
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button id="btn-auth" class="btn btn-ghost">ƒêƒÉng nh·∫≠p Google</button>
                <button id="btn-signout" class="btn btn-ghost">ƒêƒÉng xu·∫•t</button>
                <span id="auth-status" class="text-xs muted"></span>
              </div>
            </div>

            <hr class="my-3">

            <div class="font-semibold mb-2">T·ª± ƒë·ªông backup</div>
            <div class="space-y-2 text-sm">
              <label class="flex items-center gap-2">
                <input type="radio" name="autoMode" value="off" class="auto-mode">
                <span>T·∫Øt</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="radio" name="autoMode" value="change" class="auto-mode">
                <span>M·ªói khi thay ƒë·ªïi (gi·ªõi h·∫°n 30s/l·∫ßn)</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="radio" name="autoMode" value="interval" class="auto-mode">
                <span>ƒê·ªãnh k·ª≥ m·ªói</span>
                <input id="auto-minutes" type="number" min="1" class="input w-20" value="5">
                <span>ph√∫t</span>
              </label>
            </div>
            <div class="text-xs text-gray-500 mt-3">
              Quy·ªÅn y√™u c·∫ßu: <code>drive.file</code> (app ch·ªâ th·∫•y/c·∫≠p nh·∫≠t file do app t·∫°o ra).
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Month Picker & Summary -->
    <section class="card bg-white rounded-2xl p-4 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="flex items-center gap-2">
          <button id="prev-month" class="btn btn-ghost" title="Th√°ng tr∆∞·ªõc">‚óÄ</button>
          <div id="month-label" class="text-lg font-bold"></div>
          <button id="next-month" class="btn btn-ghost" title="Th√°ng sau">‚ñ∂</button>
        </div>
        <div class="grid grid-cols-3 gap-2 text-center text-sm">
          <div class="bg-gray-100 rounded-xl p-3">
            <div id="sum-income" class="text-green-600 font-bold text-base">0</div>
            <div class="text-gray-500 text-xs">Thu nh·∫≠p</div>
          </div>
          <div class="bg-gray-100 rounded-xl p-3">
            <div id="sum-expense" class="text-red-600 font-bold text-base">0</div>
            <div class="text-gray-500 text-xs">Chi ti√™u</div>
          </div>
          <div class="bg-gray-100 rounded-xl p-3">
            <div id="sum-balance" class="font-bold text-base">0</div>
            <div class="text-gray-500 text-xs">S·ªë d∆∞</div>
          </div>
        </div>
      </div>

      <!-- Calendar -->
      <div class="mt-4">
        <div class="grid grid-cols-7 gap-1 text-center font-medium text-xs text-gray-500">
          <div>T2</div><div>T3</div><div>T4</div><div>T5</div><div>T6</div><div>T7</div><div>CN</div>
        </div>
        <div id="calendar" class="grid grid-cols-7 gap-1 mt-2"></div>
      </div>
    </section>

    <!-- Chart + Controls -->
    <section class="grid md:grid-cols-2 gap-4 sm:gap-6 mt-4">
      <div class="card bg-white rounded-2xl p-4 sm:p-6">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-bold">Bi·ªÉu ƒë·ªì chi ti√™u (th√°ng)</h2>
          <span class="chip" id="chart-month"></span>
        </div>
        <canvas id="pie"></canvas>
      </div>

      <div class="card bg-white rounded-2xl p-4 sm:p-6">
        <div class="flex gap-2 mb-3">
          <input id="search" class="input" placeholder="T√¨m m√¥ t·∫£...">
          <select id="sort" class="select w-44">
            <option value="createdAt-desc">M·ªõi nh·∫•t</option>
            <option value="createdAt-asc">C≈© nh·∫•t</option>
            <option value="amount-desc">S·ªë ti·ªÅn ‚Üì</option>
            <option value="amount-asc">S·ªë ti·ªÅn ‚Üë</option>
          </select>
        </div>
        <div id="list" class="space-y-3 max-h-[360px] overflow-auto pr-1"></div>
      </div>
    </section>

    <!-- Add/Edit Form -->
    <section class="card bg-white rounded-2xl p-4 sm:p-6 mt-4 sm:mt-6">
      <h2 class="font-bold mb-3">Th√™m / S·ª≠a giao d·ªãch</h2>
      <form id="form" class="grid md:grid-cols-2 gap-3">
        <input type="hidden" id="tx-id">
        <div>
          <label class="text-sm text-gray-600">S·ªë ti·ªÅn (VND)</label>
          <input id="amount" class="input" placeholder="VD: 120000">
        </div>
        <div>
          <label class="text-sm text-gray-600">M√¥ t·∫£</label>
          <input id="description" class="input" placeholder="VD: C√† ph√™">
        </div>
        <div>
          <label class="text-sm text-gray-600">Ng√†y</label>
          <input id="date" type="date" class="input">
        </div>
        <div>
          <label class="text-sm text-gray-600">Lo·∫°i</label>
          <select id="type" class="select">
            <option value="expense">Chi ph√≠</option>
            <option value="income">Thu nh·∫≠p</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-600">Danh m·ª•c</label>
          <select id="category" class="select"></select>
        </div>
        <div class="flex items-end gap-2">
          <button class="btn btn-primary" id="save">L∆∞u</button>
          <button type="button" class="btn btn-ghost" id="reset">L√†m m·ªõi</button>
        </div>
      </form>
    </section>

    <footer class="text-center text-xs text-gray-500 mt-6">
      D·ªØ li·ªáu l∆∞u c·ª•c b·ªô (localStorage) + c√≥ th·ªÉ ƒë·ªìng b·ªô l√™n Google Drive (y√™u c·∫ßu client ID & ƒëƒÉng nh·∫≠p).
    </footer>
  </div>

<script>
// ====== Constants ======
const CATEGORIES = [
  { key: 'ƒÇn u·ªëng', color: '#FCD34D' },
  { key: 'Ph√≠ giao l∆∞u', color: '#FFCA28' },
  { key: 'Y t·∫ø', color: '#4CAF50' },
  { key: 'M·ªπ ph·∫©m', color: '#F48FB1' },
  { key: 'Ti·ªÅn ƒëi·ªán', color: '#03A9F4' },
  { key: 'Ti·ªÅn nh√†', color: '#FFB74D' },
  { key: 'Gi√°o d·ª•c', color: '#E57373' },
  { key: 'Qu·∫ßn √°o', color: '#5C6BC0' },
  { key: 'Chi ti√™u kh√°c', color: '#9E9E9E' },
  { key: 'Thu nh·∫≠p kh√°c', color: '#66BB6A' },
];

// ====== Storage ======
const STORAGE_KEY = 'xpense.v1';
const SETTINGS_KEY = 'xpense.settings.drive.v1';
const loadAll = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
const saveAll = (arr) => {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  onDataChanged();
};

const defaultSettings = { mode:'off', minutes:5, lastBackup:0, clientId:'', fileName:'chi_tieu.json', fileId:'', token:'' };
const loadSettings = () => Object.assign({}, defaultSettings, JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}'));
const saveSettings = (s) => localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));

// ====== Helpers ======
const fmt = (n) => Number(n||0).toLocaleString('vi-VN');
const todayStr = () => new Date().toISOString().slice(0,10);
const byMonth = (d) => ({y:d.getFullYear(), m:d.getMonth()}); // 0-index
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

// ====== State ======
let state = {
  selected: new Date(),
  search: '',
  sort: 'createdAt-desc',
  data: loadAll(),
  editingId: null,
  settings: loadSettings(),
  intervalId: null,
  oauth: { token: null, expires: 0, client: null }
};

// Seed demo
if (!state.data.length) {
  state.data = [
    { id: crypto.randomUUID(), amount: 35000, description: 'C√† ph√™', type:'expense', category:'ƒÇn u·ªëng', createdAt: new Date().toISOString() },
    { id: crypto.randomUUID(), amount: 5000000, description: 'L∆∞∆°ng', type:'income', category:'Thu nh·∫≠p kh√°c', createdAt: new Date().toISOString() },
    { id: crypto.randomUUID(), amount: 250000, description: 'Si√™u th·ªã', type:'expense', category:'ƒÇn u·ªëng', createdAt: new Date().toISOString() },
  ];
  saveAll(state.data);
}

// ====== Elements ======
const el = {
  monthLabel: document.getElementById('month-label'),
  calendar: document.getElementById('calendar'),
  sumIncome: document.getElementById('sum-income'),
  sumExpense: document.getElementById('sum-expense'),
  sumBalance: document.getElementById('sum-balance'),
  chartMonth: document.getElementById('chart-month'),
  list: document.getElementById('list'),
  search: document.getElementById('search'),
  sort: document.getElementById('sort'),
  form: document.getElementById('form'),
  amount: document.getElementById('amount'),
  description: document.getElementById('description'),
  date: document.getElementById('date'),
  type: document.getElementById('type'),
  category: document.getElementById('category'),
  txId: document.getElementById('tx-id'),
  reset: document.getElementById('reset'),
  prev: document.getElementById('prev-month'),
  next: document.getElementById('next-month'),
  exportBtn: document.getElementById('btn-export'),
  importFile: document.getElementById('file-import'),
  pie: document.getElementById('pie'),
  settingsBtn: document.getElementById('btn-settings'),
  settingsPanel: document.getElementById('panel-settings'),
  autoModes: null,
  autoMinutes: document.getElementById('auto-minutes'),
  authBtn: document.getElementById('btn-auth'),
  signoutBtn: document.getElementById('btn-signout'),
  authStatus: document.getElementById('auth-status'),
  clientId: document.getElementById('gis-client-id'),
  fileName: document.getElementById('drive-filename'),
  fileId: document.getElementById('drive-fileid'),
  backupNow: document.getElementById('btn-backup-now'),
};

// Fill categories
el.category.innerHTML = CATEGORIES.map(c => `<option value="${c.key}">${c.key}</option>`).join('');
el.date.value = todayStr();

// Load settings into UI
function syncSettingsToUI(){
  el.clientId.value = state.settings.clientId || '';
  el.fileName.value = state.settings.fileName || 'chi_tieu.json';
  el.fileId.value = state.settings.fileId || '';
  el.settingsPanel.querySelectorAll('input.auto-mode').forEach(r => r.checked = (r.value === state.settings.mode));
  el.autoMinutes.value = state.settings.minutes || 5;
  updateAuthStatus();
}
syncSettingsToUI();

// ====== Calendar Render ======
function renderCalendar() {
  const d = state.selected;
  const y = d.getFullYear();
  const m = d.getMonth();
  el.monthLabel.textContent = `th√°ng ${m+1} nƒÉm ${y}`;
  el.chartMonth.textContent = `${m+1}/${y}`;

  const first = new Date(y, m, 1);
  const last = new Date(y, m+1, 0).getDate();
  const lead = (first.getDay() + 6) % 7; // Mon=0 ... Sun=6
  const cells = [];

  for (let i=0; i<lead; i++) cells.push(null);
  for (let d=1; d<=last; d++) cells.push(d);

  el.calendar.innerHTML = cells.map(day => {
    if (!day) return `<div></div>`;
    const isSel = day === state.selected.getDate();
    return `<button data-day="${day}"
      class="h-10 sm:h-12 rounded-lg ${isSel ? 'bg-pink-500 text-white' : 'bg-white hover:bg-gray-100'}">
      ${day}
    </button>`;
  }).join('');

  // Bind clicks
  el.calendar.querySelectorAll('button[data-day]').forEach(b => {
    b.addEventListener('click', () => {
      const day = Number(b.getAttribute('data-day'));
      state.selected = new Date(y, m, day);
      render();
    });
  });
}

// ====== List + Summary Render ======
function getMonthData() {
  const { y, m } = byMonth(state.selected);
  return state.data.filter(t => {
    const dt = new Date(t.createdAt);
    return dt.getFullYear() === y && dt.getMonth() === m;
  });
}
function getDayData() {
  const sel = state.selected.toDateString();
  return getMonthData().filter(t => new Date(t.createdAt).toDateString() === sel);
}

function renderSummary() {
  const month = getMonthData();
  const income = month.filter(t=>t.type==='income').reduce((s,t)=>s+Number(t.amount||0),0);
  const expense = month.filter(t=>t.type==='expense').reduce((s,t)=>s+Number(t.amount||0),0);
  const balance = income - expense;
  el.sumIncome.textContent = fmt(income);
  el.sumExpense.textContent = fmt(expense);
  el.sumBalance.textContent = fmt(balance);
  el.sumBalance.className = `font-bold text-base ${balance >= 0 ? 'text-blue-600' : 'text-red-600'}`;
}

function renderList() {
  const q = (document.getElementById('search').value || '').trim().toLowerCase();
  let arr = getDayData().filter(t => (t.description || '').toLowerCase().includes(q));

  const [key, dir] = (document.getElementById('sort').value || 'createdAt-desc').split('-');
  arr.sort((a,b) => {
    if (key === 'createdAt') return dir === 'asc' ? (new Date(a.createdAt)-new Date(b.createdAt)) : (new Date(b.createdAt)-new Date(a.createdAt));
    if (key === 'amount') return dir === 'asc' ? (a.amount-b.amount) : (b.amount-a.amount);
    return 0;
  });

  el.list.innerHTML = arr.map(t => `
    <div class="bg-gray-50 hover:bg-gray-100 rounded-xl p-3 flex justify-between items-center">
      <div>
        <div class="font-semibold">${t.description}</div>
        <div class="text-xs text-gray-500 mt-0.5">${new Date(t.createdAt).toLocaleString('vi-VN')}</div>
        <div class="text-xs mt-1"><span class="chip">${t.category}</span> <span class="chip">${t.type==='expense'?'Chi ph√≠':'Thu nh·∫≠p'}</span></div>
      </div>
      <div class="text-right">
        <div class="font-bold ${t.type==='expense'?'text-red-600':'text-green-600'}">${t.type==='expense'?'-':'+'}${fmt(t.amount)}</div>
        <div class="mt-1 flex gap-1 justify-end">
          <button class="btn btn-ghost text-blue-600" data-edit="${t.id}">S·ª≠a</button>
          <button class="btn btn-ghost text-red-600" data-del="${t.id}">X√≥a</button>
        </div>
      </div>
    </div>
  `).join('');

  // Bind edit/delete
  el.list.querySelectorAll('button[data-edit]').forEach(b => b.addEventListener('click', () => startEdit(b.getAttribute('data-edit'))));
  el.list.querySelectorAll('button[data-del]').forEach(b => b.addEventListener('click', () => delTx(b.getAttribute('data-del'))));
}

// ====== Chart Render ======
let pieChart = null;
function renderChart() {
  const month = getMonthData().filter(t=>t.type==='expense');
  const totals = {};
  month.forEach(t => totals[t.category] = (totals[t.category]||0) + Number(t.amount||0));

  const labels = Object.keys(totals);
  const values = labels.map(k => totals[k]);
  const colors = labels.map(l => (CATEGORIES.find(c=>c.key===l)?.color) || '#9CA3AF');

  if (pieChart) { pieChart.destroy(); }
  pieChart = new Chart(el.pie, {
    type: 'pie',
    data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
    options: { plugins: { legend: { position: 'bottom' } } }
  });
}

// ====== CRUD ======
function upsertTx(tx){
  const idx = state.data.findIndex(x=>x.id===tx.id);
  if (idx >= 0) state.data[idx] = tx;
  else state.data.unshift(tx);
  saveAll(state.data);
  render();
}
function delTx(id){
  state.data = state.data.filter(x=>x.id!==id);
  saveAll(state.data);
  render();
}
function startEdit(id){
  const t = state.data.find(x=>x.id===id);
  if (!t) return;
  state.editingId = id;
  document.getElementById('tx-id').value = id;
  el.amount.value = t.amount;
  el.description.value = t.description;
  el.date.value = new Date(t.createdAt).toISOString().slice(0,10);
  el.type.value = t.type;
  el.category.value = t.category;
  el.amount.focus();
}

// ====== Manual export/import ======
el.exportBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `chi_tieu_${Date.now()}.json`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
});
el.importFile.addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const arr = JSON.parse(reader.result);
      if (!Array.isArray(arr)) throw new Error('File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng');
      const cleaned = arr.map(t => ({
        id: t.id || crypto.randomUUID(),
        amount: Number(t.amount)||0,
        description: t.description || '',
        type: (t.type==='income'?'income':'expense'),
        category: t.category || 'Chi ti√™u kh√°c',
        createdAt: t.createdAt || new Date().toISOString(),
      }));
      state.data = cleaned;
      saveAll(state.data);
      render();
      e.target.value = '';
    } catch(err) { alert('Kh√¥ng th·ªÉ nh·∫≠p: ' + err.message); }
  };
  reader.readAsText(file);
});

// ====== Google Drive Upload ======
// Using Google Identity Services for token issuance.
const SCOPE = 'https://www.googleapis.com/auth/drive.file';

function updateAuthStatus(){
  el.authStatus.textContent = state.oauth.token ? 'ƒê√£ ƒëƒÉng nh·∫≠p' : 'Ch∆∞a ƒëƒÉng nh·∫≠p';
}

async function ensureTokenInteractive(){
  const clientId = (el.clientId.value || '').trim();
  if (!clientId) { alert('Nh·∫≠p Google OAuth Client ID trong C√†i ƒë·∫∑t.'); return null; }

  return new Promise((resolve) => {
    /* global google */
    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: SCOPE,
      prompt: state.oauth.token ? '' : 'consent',
      callback: (resp) => {
        if (resp && resp.access_token) {
          state.oauth.token = resp.access_token;
          state.settings.clientId = clientId;
          saveSettings(state.settings);
          updateAuthStatus();
          resolve(resp.access_token);
        } else {
          resolve(null);
        }
      }
    });
    tokenClient.requestAccessToken();
  });
}

async function uploadToDrive(auto=false){
  try {
    let token = state.oauth.token;
    if (!token) token = await ensureTokenInteractive();
    if (!token) return;

    const fileName = (el.fileName.value || 'chi_tieu.json').trim();
    const fileIdInput = (el.fileId.value || '').trim();

    const content = JSON.stringify(state.data, null, 2);
    const metadata = { name: fileName };
    const boundary = '-------314159265358979323846';
    const delimiter = '\\r\\n--' + boundary + '\\r\\n';
    const closeDelim = '\\r\\n--' + boundary + '--';

    const body =
      delimiter + 'Content-Type: application/json; charset=UTF-8\\r\\n\\r\\n' +
      JSON.stringify(metadata) +
      delimiter + 'Content-Type: application/json\\r\\n\\r\\n' +
      content + closeDelim;

    const method = fileIdInput ? 'PATCH' : 'POST';
    const url = fileIdInput
      ? `https://www.googleapis.com/upload/drive/v3/files/${encodeURIComponent(fileIdInput)}?uploadType=multipart`
      : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';

    const res = await fetch(url, {
      method,
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'multipart/related; boundary=' + boundary
      },
      body
    });

    if (!res.ok) {
      const txt = await res.text();
      throw new Error('Upload th·∫•t b·∫°i: ' + res.status + ' ' + txt);
    }
    const json = await res.json();
    el.fileId.value = json.id || fileIdInput;
    state.settings.fileId = el.fileId.value;
    state.settings.fileName = fileName;
    saveSettings(state.settings);
    if (!auto) alert('ƒê√£ sao l∆∞u l√™n Google Drive!\\nFile ID: ' + el.fileId.value);
  } catch (e) {
    console.error(e);
    if (!auto) alert(e.message);
  }
}

// Manual backup button
el.backupNow.addEventListener('click', ()=> uploadToDrive(false));

// ====== Auto-backup logic ======
let backupTimer = null;
function onDataChanged(){
  const s = state.settings;
  if (s.mode === 'change') {
    const now = Date.now();
    if (now - (s.lastBackup||0) < 30_000) return; // 30s window
    clearTimeout(backupTimer);
    backupTimer = setTimeout(async ()=>{
      await uploadToDrive(true);
      s.lastBackup = Date.now();
      saveSettings(s);
    }, 800);
  }
}
function setupInterval(){
  if (state.intervalId) { clearInterval(state.intervalId); state.intervalId = null; }
  const s = state.settings;
  if (s.mode === 'interval') {
    const ms = Math.max(1, Number(s.minutes||5)) * 60_000;
    state.intervalId = setInterval(async ()=>{
      await uploadToDrive(true);
      s.lastBackup = Date.now();
      saveSettings(s);
    }, ms);
  }
}

// ====== Settings UI & events ======
el.settingsBtn.addEventListener('click', ()=>{
  el.settingsPanel.classList.toggle('hidden');
  syncSettingsToUI();
});
document.addEventListener('click', (e)=>{
  if (!el.settingsPanel.contains(e.target) && e.target !== el.settingsBtn) {
    el.settingsPanel.classList.add('hidden');
  }
});
el.clientId.addEventListener('change', ()=>{
  state.settings.clientId = el.clientId.value.trim();
  saveSettings(state.settings);
});
el.fileName.addEventListener('change', ()=>{
  state.settings.fileName = el.fileName.value.trim();
  saveSettings(state.settings);
});
el.fileId.addEventListener('change', ()=>{
  state.settings.fileId = el.fileId.value.trim();
  saveSettings(state.settings);
});

function bindAutoRadios(){
  el.settingsPanel.querySelectorAll('input.auto-mode').forEach(r => {
    r.addEventListener('change', ()=>{
      state.settings.mode = r.value;
      saveSettings(state.settings);
      setupInterval();
    });
  });
}
bindAutoRadios();
el.autoMinutes.addEventListener('change', ()=>{
  const v = Math.max(1, Number(el.autoMinutes.value||5));
  state.settings.minutes = v;
  saveSettings(state.settings);
  setupInterval();
});

// Auth buttons
el.authBtn.addEventListener('click', ensureTokenInteractive);
el.signoutBtn.addEventListener('click', ()=>{
  state.oauth.token = null;
  updateAuthStatus();
});

// ====== Core UI events ======
el.prev.addEventListener('click', ()=>{ const d=new Date(state.selected); d.setMonth(d.getMonth()-1); state.selected=d; render(); });
el.next.addEventListener('click', ()=>{ const d=new Date(state.selected); d.setMonth(d.getMonth()+1); state.selected=d; render(); });
el.search.addEventListener('input', ()=> renderList());
el.sort.addEventListener('change', ()=> renderList());
el.reset.addEventListener('click', (e)=>{
  e.preventDefault();
  state.editingId = null;
  document.getElementById('tx-id').value='';
  el.amount.value='';
  el.description.value='';
  el.date.value=todayStr();
  el.type.value='expense';
  el.category.value=CATEGORIES[0].key;
});
el.form.addEventListener('submit', (e)=>{
  e.preventDefault();
  const amount = parseFloat((el.amount.value+'').replace(/[^\d.-]/g,''));
  if (isNaN(amount) || amount <= 0) { alert('S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá'); return; }
  const tx = {
    id: document.getElementById('tx-id').value || crypto.randomUUID(),
    amount,
    description: el.description.value.trim() || '(Kh√¥ng m√¥ t·∫£)',
    type: el.type.value,
    category: el.category.value,
    createdAt: new Date(el.date.value || todayStr()).toISOString(),
  };
  const idx = state.data.findIndex(x=>x.id===tx.id);
  if (idx >= 0) state.data[idx] = tx; else state.data.unshift(tx);
  saveAll(state.data);
  el.reset.click();
});

// ====== Render Root ======
function render(){
  renderCalendar();
  renderSummary();
  renderList();
  renderChart();
}
setupInterval();
render();
</script>
</body>
</html>
